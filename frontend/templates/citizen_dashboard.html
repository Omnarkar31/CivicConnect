{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border-start border-primary border-4">
    <div>
        <h4 class="mb-0 text-primary fw-bold">Citizen Portal</h4>
        <small class="text-muted">Welcome, {{ current_user.name }} (Ward {{ current_user.ward.ward_number }})</small>
    </div>
</div>

<div class="row g-4">
    <div class="{% if view != 'default' %}col-md-4{% else %}col-md-12{% endif %} transition-all">
        <div class="row g-3">
            <div class="{% if view != 'default' %}col-12{% else %}col-md-4{% endif %}">
                <a href="{{ url_for('citizen_dashboard', view='report') }}" class="text-decoration-none">
                    <div class="card p-4 text-center hover-card shadow-sm {% if view == 'report' %}bg-primary text-white{% endif %}">
                        <img src="https://cdn-icons-png.flaticon.com/512/6206/6206594.png" width="60" class="mx-auto mb-3">
                        <h5 class="fw-bold">Report Problem</h5>
                    </div>
                </a>
            </div>

            <div class="{% if view != 'default' %}col-12{% else %}col-md-4{% endif %}">
                <a href="{{ url_for('citizen_dashboard', view='projects') }}" class="text-decoration-none">
                    <div class="card p-4 text-center hover-card shadow-sm {% if view == 'projects' %}bg-primary text-white{% endif %}">
                        <img src="https://cdn-icons-png.flaticon.com/128/5956/5956494.png" alt="Project Icon" width="60" class="mx-auto mb-3">
                        <h5 class="fw-bold">Ongoing Ward Projects</h5>
                    </div>
                </a>
            </div>

            <div class="{% if view != 'default' %}col-12{% else %}col-md-4{% endif %}">
                <a href="{{ url_for('citizen_dashboard', view='track') }}" class="text-decoration-none">
                    <div class="card p-4 text-center hover-card shadow-sm {% if view == 'track' %}bg-primary text-white{% endif %}">
                        <img src="https://cdn-icons-png.flaticon.com/512/2666/2666505.png" width="60" class="mx-auto mb-3">
                        <h5 class="fw-bold">Track Status</h5>
                    </div>
                </a>
            </div>
        </div>
    </div>

    {% if view != 'default' %}
    <div class="col-md-8 animate-in">
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>
                    {% if view == 'report' %}New Report
                    {% elif view == 'projects' %}Ongoing Ward Projects
                    {% else %}Status History{% endif %}
                </span>
                <a href="{{ url_for('citizen_dashboard') }}" class="text-white text-decoration-none fw-bold">âœ•</a>
            </div>
            <div class="card-body">
                
                {% if view == 'report' %}
                <form action="{{ url_for('submit_complaint') }}" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Issue Category</label>
                        <select name="category" class="form-select" required>
                            <option value="Roads">Roads/Potholes</option>
                            <option value="Water">Water Supply</option>
                            <option value="Electricity">Electricity/Streetlights</option>
                            <option value="Waste">Waste Management</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Problem Description</label>
                        <textarea name="description" class="form-control" rows="4" placeholder="Enter details..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Attach files (images, videos, PDF)</label>
                        <input type="file" name="attachments" class="form-control" accept="image/*,video/*,.pdf,application/pdf" multiple>
                        <small class="text-muted">You can select multiple files. Allowed: images (PNG, JPG, GIF, WebP), videos (MP4, WebM, MOV, AVI), PDF.</small>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 fw-bold">Submit Grievance</button>
                </form>

                {% elif view == 'projects' %}
                <div class="list-group">
                    {% for project in projects %}
                    <div class="list-group-item list-group-item-action mb-2 rounded border">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 fw-bold">{{ project.name }}</h6>
                            <small class="text-primary">{{ project.completion_percentage }}%</small>
                        </div>
                        <p class="mb-1 small">{{ project.description }}</p>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ project.completion_percentage }}%"></div>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-center py-4 text-muted">No ongoing projects in your ward at this time.</p>
                    {% endfor %}
                </div>

                {% else %}
                <p class="small text-muted mb-3">Track your complaint status and work-in-progress photos updated by the ward admin. Refresh the page to see the latest status.</p>
                <div class="list-group list-group-flush">
                    {% for c in complaints %}
                    <div class="list-group-item border-start border-0 border-end border-0 border-bottom">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">{{ c.category }}</h6>
                                <p class="mb-1 small text-muted">{{ (c.description or '')[:120] }}{% if (c.description or '')|length > 120 %}...{% endif %}</p>
                                <small class="text-muted d-block mt-1">Submitted {{ c.created_at.strftime('%d %b %Y') if c.created_at else '' }}</small>
                            </div>
                            <div class="text-end">
                                <div class="small text-muted mb-1">Current status (updated by admin)</div>
                                <span class="badge {% if c.status == 'Completed' %}bg-success{% elif c.status == 'In Process' %}bg-info{% else %}bg-warning text-dark{% endif %} px-3 py-2 fs-6">{{ c.status }}</span>
                            </div>
                        </div>
                        {% if c.work_photos %}
                        <div class="mt-3 pt-2 border-top">
                            <span class="small fw-bold text-muted d-block mb-2">Work progress photos (by admin)</span>
                            <div class="d-flex flex-wrap gap-2">
                                {% for path in c.work_photos.split(',') %}
                                {% set path = path.strip().replace('\\', '/') %}
                                {% if path %}
                                <a href="{{ url_for('serve_upload', filename=path) }}" target="_blank" class="d-inline-block"><img src="{{ url_for('serve_upload', filename=path) }}" alt="Work progress" class="rounded border" style="max-height: 100px; max-width: 120px; object-fit: cover;"></a>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="list-group-item text-center text-muted py-4">No grievances submitted yet.</div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .hover-card { transition: 0.3s; border: 2px solid transparent; cursor: pointer; }
    .hover-card:hover { transform: translateY(-5px); border-color: #0d6efd; }
    .animate-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .transition-all { transition: all 0.3s ease; }
</style>
{% endblock %}